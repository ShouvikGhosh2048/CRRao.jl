CRRao.set_rng(StableRNG(123))

mtcars = dataset("datasets", "mtcars")

@testset "OLS" begin
    model = @fitmodel((MPG ~ HP + WT + Gear), mtcars, LinearRegression())

    @test model.fit.cols ≈ [
        [32.01365679074491, -0.03678605889338903, -3.1978106240485467, 1.0199808687184484], 
        [4.632264086003881, 0.009891461620298145, 0.8465458699304196, 0.8514083837234175], 
        [6.9110172037626985, -3.7189709979666525, -3.7774806276136994, 1.1979925124272586], 
        [1.6383852102488675e-7, 0.0008879421680332547, 0.0007605933136019097, 0.2409627017003867], 
        [22.524893954292942, -0.05704779951920132, -4.931881229871286, -0.7240501450849461], 
        [41.50241962719688, -0.016524318267576752, -1.4637400182258071, 2.764011882521843]
    ]

    @test model.sigma ≈ 2.5741691724978977
    @test model.LogLike ≈ -73.52638935960971
    @test model.AIC ≈ 157.05277871921942
    @test model.BIC ≈ 164.38145823321804
    @test model.R_sqr ≈ 0.8352309600685555
    @test model.Adjusted_R_sqr ≈ 0.8175771343616149

    @test model.fittedResponse ≈ [
        23.668849952338718, 22.85340824320634, 
        25.253556140740894, 20.746171762311384, 
        17.635570543830177, 20.14663845388644, 
        14.644831040166633, 23.61182872351372, 
        22.525801204993822, 20.568426475004856,
        20.568426475004856, 15.437019556212643, 
        16.52427516838915, 16.364384637186724, 
        10.743951547500636, 9.819671909982297, 
        9.520508065881298, 26.630517005748224, 
        29.016241045324072, 27.83450394241933, 
        23.622748495961854, 18.299397166241015, 
        18.57121106928514, 13.781422171673526, 
        16.340457241090512, 27.47793682112109,
        26.922715039574857, 28.11844900519874, 
        17.264981908248554, 21.818065399379595,
        13.374047477198516, 23.193986311384343
    ]

    @test model.residuals ≈ [
        -2.668849952338718, -1.8534082432063386, 
        -2.4535561407408935, 0.6538282376886144, 
        1.0644294561698224, -2.0466384538864375, 
        -0.3448310401666319, 0.7881712764862776, 
        0.2741987950061784, -1.3684264750048563, 
        -2.768426475004855, 0.9629804437873553, 
        0.7757248316108516, -1.1643846371867248, 
        -0.3439515475006356, 0.5803280900177032, 
        5.179491934118701, 5.769482994251774, 
        1.3837589546759261, 6.065496057580667, 
        -2.1227484959618543, -2.7993971662410146, 
        -3.371211069285142, -0.4814221716735254, 
        2.8595427589094875, -0.1779368211210901, 
        -0.9227150395748573, 2.2815509948012576, 
        -1.4649819082485536, -2.1180653993795957, 
        1.6259525228014837, -1.7939863113843444
    ]

    @test model.Cooks_distance ≈ [
        0.013342034282302797, 0.006887282667312196, 
        0.015495847517059158, 0.0014309089637597762,
        0.00447197921392359, 0.014588985833725162, 
        0.0015401004198819339, 0.005826402580871438, 
        0.0003074315682458216, 0.007011803724485459, 
        0.028698077402054694, 0.0025984983592199293, 
        0.0018259935015465612, 0.003961518883315901, 
        0.0014122489772288866, 0.004961031834940678, 
        0.3111039446698831, 0.11872557592945515, 
        0.01267921344874388, 0.18027152389575862,
        0.03551409534596339, 0.02132188661223607, 
        0.033303982249972226, 0.002076825609693457, 
        0.022039704192128574, 0.0001378106083285506, 
        0.006862929526074501, 0.04703889945177856, 
        0.03812045131808726, 0.03540469459036061, 
        0.1371534135504359, 0.00614566032951969
    ]
end

@testset "Priors" begin
    tests = [
        (
            Prior_Ridge(),
            (
                parameters = [:v, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                mean = [6.9095268943380415, 2.6726362707231637, 28.685991221080055, -0.03953360677100602, -2.705564056661242, 1.591263013739982], 
                std = [3.7792614555152246, 0.38775467629180516, 5.420599994640154, 0.01063484672913348, 0.963494671564521, 0.9825623445432003], 
                naive_se = [0.037792614555152246, 0.0038775467629180516, 0.054205999946401545, 0.0001063484672913348, 0.00963494671564521, 0.009825623445432002], 
                mcse = [0.061570860440974685, 0.006070321878220963, 0.11119232199410697, 0.00015463615095760301, 0.017691117014984784, 0.01992719524457058], 
                ess = [3844.804190009132, 3786.030915197147, 2428.3514120242326, 4056.8770291324627, 2896.929532481685, 2537.8983076697896], 
                rhat = [0.9999002309827513, 0.9999688935658809, 1.0001184726817602, 0.9999336991325012, 1.0000501195134504, 1.0000600447822101]
            ),
            ( 
                [:v, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                [2.5200308046471234, 2.0518510184800562, 17.603419947586804, -0.061151881292449056, -4.516344038435958, -0.2204750509380125], 
                [4.501359459070388, 2.4030871556429365, 25.26123373020878, -0.04636651581036802, -3.344282581659076, 0.9158040706515994], 
                [6.039690457772275, 2.629829905844172, 28.921568148298505, -0.039267964863226576, -2.7383097908294864, 1.5519641303956502], 
                [8.236667363183816, 2.8942335196927464, 32.335961001159546, -0.03250962951472595, -2.104068213831705, 2.203557249964137], 
                [16.62198110518631, 3.548183645845648, 38.73425506342391, -0.01912991814931216, -0.7210813215190509, 3.6201660170073753]
            )
        ),
        (
            Prior_Laplace(),
            (
                parameters = [:v, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                mean = [4.221305330862485, 2.6712857355498083, 29.05180600072326, -0.0397541650510669, -2.716010761289841, 1.5129162323916863], 
                std = [3.065282118489999, 0.38286891539171874, 5.25919207844858, 0.010646279004714553, 0.9506823917368245, 0.9530493662118539], 
                naive_se = [0.030652821184899988, 0.0038286891539171873, 0.052591920784485796, 0.00010646279004714551, 0.009506823917368245, 0.009530493662118538], 
                mcse = [0.049698424331672694, 0.006684121566474188, 0.10525923080598872, 0.00017508827100787887, 0.01859050295006797, 0.018305471687104585], 
                ess = [3799.9578471500354, 3782.6926320299126, 3145.6652204305897, 4430.086629322592, 3299.607254263406, 3385.2723646888994], 
                rhat = [0.999935566211926, 1.0000873016503087, 1.0003664593225428, 1.0004797435928896, 1.0008864398135444, 1.000211665875392]
            ),
            (
                [:v, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                [1.2437873544139264, 2.0691638311416827, 17.805587665344394, -0.06140350187630703, -4.55585046297978, -0.2789517899778435], 
                [2.37883045573142, 2.401643771674853, 25.799537661679118, -0.04664335093469242, -3.3384484233025047, 0.8793931544081637], 
                [3.4110249206303824, 2.622621662871624, 29.28655986862489, -0.039509774905792674, -2.740470504069857, 1.4690911078660251], 
                [5.113830670043022, 2.889631217587783, 32.53847405895425, -0.03258953048458116, -2.1202521057068133, 2.109814232083624], 
                [11.742312246219342, 3.560184912163643, 38.88891209308056, -0.01941224339731591, -0.7253524456559105, 3.5245319303197196]
            )
        ),
        (
            Prior_Cauchy(),
            (
                parameters = [:σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                mean = [2.5927995363742045, 30.12308615166455, -0.039675496475364364, -2.808596915542546, 1.3060552204719318], 
                std = [0.34169998572198185, 4.698671989853137, 0.010046258714503839, 0.8658817780873869, 0.8566109067302865], 
                naive_se = [0.003416999857219818, 0.04698671989853137, 0.00010046258714503839, 0.008658817780873868, 0.008566109067302865], 
                mcse = [0.005193055505615749, 0.08408422237582376, 0.00016040740990930447, 0.015235252897303521, 0.015156681340554796], 
                ess = [4051.287961978882, 2722.6932321950826, 4005.977529346598, 2893.7890379605697, 2909.274585333947], 
                rhat = [1.0000147157315655, 0.9999000926466289, 0.9999143309256767, 0.9999564860442287, 0.9999275041065625]
            ),
            (
                [:σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                [2.0162281900009416, 20.505645331671136, -0.05994221775780337, -4.5044584532846885, -0.34011138676218994], 
                [2.3499911311745816, 27.145010892088365, -0.046032826861888046, -3.3759697030773657, 0.7342982534482262], 
                [2.5597313653250784, 30.227928768883203, -0.039499799809295924, -2.8230334798687897, 1.2907842833974283], 
                [2.8033772594050173, 33.24925770201179, -0.03303981328925928, -2.2374703629912287, 1.8556848280304727], 
                [3.3556365329802205, 39.065228300459744, -0.020177985750382415, -1.1062055202813632, 3.03740323355194]
            )
        ),
        (
            Prior_TDist(),
            (
                parameters = [:ν, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                mean = [1.0537440481045595, 2.625059914101095, 30.185829909703287, -0.039569233887111296, -2.8098819850259686, 1.2856365021842502], 
                std = [0.557609877013822, 0.35590218819364755, 4.793440619814514, 0.0102500783634789, 0.8772519954310951, 0.8698824037501052], 
                naive_se = [0.00557609877013822, 0.0035590218819364756, 0.04793440619814514, 0.00010250078363478901, 0.008772519954310953, 0.008698824037501052], 
                mcse = [0.014332899646783985, 0.004264946904873641, 0.061523842056483355, 0.00012755250047041816, 0.011513821734351238, 0.010733896240494577], 
                ess = [1340.7451120768717, 6385.053930046334, 5362.273777017748, 5835.805446685191, 5301.413948676526, 5752.204465892912], 
                rhat = [0.9999235441693242, 0.9999392299499564, 1.0006242947855921, 1.000264546413211, 1.0009730233968706, 1.0002823848393427]
            ),
            (
                [:ν, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                [0.36699618780538135, 2.0326805314018332, 20.481575301819916, -0.0598664455643371, -4.492351303091096, -0.3642433259302875], 
                [0.6600384146309358, 2.375397824027449, 27.068488879529532, -0.04640238038321162, -3.3901574753312524, 0.7021156695544545], 
                [0.9300333689642808, 2.588384856876708, 30.27868744475205, -0.03956746416463863, -2.8249904633076826, 1.264172172496013], 
                [1.2960992994202327, 2.8441554039206505, 33.448113149933874, -0.032618178617300604, -2.2351205221514387, 1.8397343793707777], 
                [2.4820521830868754, 3.439301222624831, 39.346229756522796, -0.01978634532504938, -1.025663667656199, 3.0849479886365563]
            )
        ),
        (
            Prior_Uniform(),
            (
                parameters = [:ν, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                mean = [1.7692376266298328e16, 1.0183323625570191e7, -50.4069345176479, -56.19755409865891, -6598.2303227266475, -2.4977829318378023e6], 
                std = [2.7598813773471545e6, 0.00042199639899076036, 1.0894625191549712e-10, 1.2893660854330365e-10, 7.185367421359359e-11, 2.421559775016096e-8], 
                naive_se = [27598.813773471546, 4.219963989907603e-6, 1.0894625191549713e-12, 1.2893660854330366e-12, 7.18536742135936e-13, 2.421559775016096e-10], 
                mcse = [276328.3361129033, 4.0544342027737495e-5, 1.0877860346382765e-11, 1.2891941985146326e-11, 0.0, 0.0], 
                ess = [20.664172215451398, 25.438629677642552, 21.307453627170087, 20.59584749787469, 20.552977468197156, 20.552977468197156], 
                rhat = [2.1090675868168436, 1.2813599439554628, 1.5248671219668137, 2.2297731480203393, 0.9998999949995, 0.9998999949995]
            ),
            (
                [:ν, :σ, :α, Symbol("β[1]"), Symbol("β[2]"), Symbol("β[3]")], 
                [1.7692376260551602e16, 1.018332362482424e7, -50.4069345178081, -56.19755409887478, -6598.230322726719, -2.4977829318378265e6], 
                [1.7692376264433492e16, 1.0183323625272818e7, -50.40693451772802, -56.1975540987667, -6598.230322726719, -2.4977829318378265e6], 
                [1.769237626660463e16, 1.0183323625517203e7, -50.406934517676234, -56.19755409865851, -6598.230322726719, -2.4977829318378265e6], 
                [1.7692376268407842e16, 1.0183323625871625e7, -50.40693451759213, -56.197554098550256, -6598.230322726719, -2.4977829318378265e6], 
                [1.7692376270993146e16, 1.0183323626487846e7, -50.406934517393694, -56.19755409841493, -6598.230322726719, -2.4977829318378265e6])
        ),
    ]

    for (prior,test_summaries,test_quantiles) in tests
        CRRao.set_rng(StableRNG(123))
        model = @fitmodel((MPG ~ HP + WT + Gear), mtcars, LinearRegression(), prior)

        #Split summaries and quantiles into symbols and numbers for testing equality/approximate equality. 
        (model_summaries_symbols, model_summaries_nums...) = model.summaries.nt
        (model_quantiles_symbols, model_quantiles_nums...) = model.quantiles.nt
        (test_summaries_symbols, test_summaries_nums...) = test_summaries
        (test_quantiles_symbols, test_quantiles_nums...) = test_quantiles

        @test model_summaries_symbols == test_summaries_symbols
        for i in 1:length(test_summaries_nums)
            @test model_summaries_nums[i] ≈ test_summaries_nums[i]
        end
        @test model_quantiles_symbols == test_quantiles_symbols
        for i in 1:length(test_quantiles_nums)
            @test model_quantiles_nums[i] ≈ test_quantiles_nums[i]
        end
    end
end